default_platform(:ios)
ios_app_extensions_podspec = "Iterable-iOS-AppExtensions.podspec"
ios_sdk_podspec = "Iterable-iOS-SDK.podspec"

platform :ios do

  desc "iOS SDK Release with specified version"
  lane :ios_release do |options|
    version = options[:version]

    # set new version number
    version_bump_podspec(path: ios_app_extensions_podspec,
                         version_number: version)
    version_bump_podspec(path: ios_sdk_podspec,
                         version_number: version)
    
    # commit new version podspecs and push to git remote
    git_add(path: ios_app_extensions_podspec)
    git_add(path: ios_sdk_podspec)
    git_commit(path: [ios_app_extensions_podspec, ios_sdk_podspec],
               message: "#{version} release")
    push_to_git_remote

    # clean and create xcframework zips
    clean_cocoapods_cache
    pod_lib_lint
  end

  lane :build_xcframework do |options|
    output_dir = options[:output_dir]
    create_xcframework(
      workspace: "swift-sdk.xcodeproj/project.xcworkspace",
      scheme: "swift-sdk",
      destinations: ['iOS', 'maccatalyst'],
      xcframework_output_directory: output_dir,
      archive_path: output_dir, 
      build_settings: "SKIP_INSTALL='NO' BUILD_LIBRARY_FOR_DISTRIBUTION='YES'",
    )
    
    add_git_tag(tag: "#{version}")
    pod_push
  end
end